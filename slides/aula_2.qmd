---
title: 'Aula 2 - Gerenciamento de Dados'
subtitle: 'Introdução ao aprendizado de máquina - UEMA 2025'
author: 'Thiago S. F .Silva'
date: 2025-12-10
format: 
    beamer:
        theme: metropolis
        urlcolor: blue
        classoption: '`xcolor={dvipsnames}`{=latex}'
        
---

# Aquecimento: dado vs informação?

# Parte I: Aspectos Gerais

## Gerenciamento de dados

- Usabilidade

- Reproducibilidade

- Transparência

- Praticidade

Quem é o seu principal colaborador?

 . . . 

- Você mesmo daqui a 3 meses.


## Dados estruturados vs. não-estruturados

- **Dados Estuturados:** planilhas, bancos de dados - dados organizados de maneira tabular.

- **Dados Não-Estruturados:** fotos, gravações, transcrições de entrevistas, paginas da web, etc. 

## Metadados

**Metadado:** O dado sobre o dado. Informação adicional / documentação explicativa que permite o uso correto e reproduzível dos dados. 

- Especialmente importante para dados não estruturados. 

- Ex: Data, hora, local, coletor, instrumento, condições ambientais, unidades, nomes de variáveis, nomenclatura dos arquivos, organização das pastas. etc.

Exemplo: [exemplo_metadado.txt](https://github.com/thiagosfsilva/ML_course_2025/blob/main/data/exemplo_metadado.txt)

Exemplo: [https://zenodo.org/records/13887881](https://zenodo.org/records/13887881)

## O gerenciamento de dados começa no campo/laboratório

- Protocolo de amostragem

- Caderno de laboratório

- Planilhas de campo

## Boas práticas

1. Faça um **estudo piloto**

2. Prepare suas planilhas / caderno **antes** de começar.

3. Anote observações sobre **tudo** o que desviar do protocolo. Não, você não vai lembrar depois.

4. **Backup, backup, backup**:

. . .
    
- Dados analógicos: 
    
    - Ao final de cada dia/sessão, **fotografe** seu caderno / planilha de campo.
    
    - Se houver acesso à internet, já sincronize com a nuvem.
        
## Boas práticas 

1. Faça um **estudo piloto**

2. Prepare suas planilhas / caderno **antes** de começar.

3. Anote observações sobre **tudo** o que desviar do protocolo. Não, você não vai lembrar depois.

4. **Backup, backup, backup**:        
   
- Dados digitais:
    
    - Baixe com a maior frequencia possível.
        
    - Mantenha pelo menos duas cópias, em dois dispositivos diferentes. 
        
    - Se houver acesso à internet, já sincronize com a nuvem. 

## Boas práticas

5. Tente digitar os dados o mais rápido possível - enquanto os detalhes do trabalho ainda estão frescos na sua cabeça.

Caderno/planilha vs. coletar dados direto no PC/tablet/telefone?


# Parte II: Aspectos Práticos

## Digitando dados

Qual software você usa pra digitar seus dados?

::: {.incremental}

- Excel: cuidado com a formatação dos dados

- Datas e horas: [formato ISO8601](https://en.wikipedia.org/wiki/ISO_8601)

- Separadores decimais e de milhar: vírgula ou ponto?

- Indicadores de dado faltante (*missing data*)

:::

## Tipos de dados (*data types*):

| Tipo de dado | nome R   | nome Excel        |
|--------------|----------|-------------------|
| Float        | numeric  | number            |
| Integer      | integer  | number            |
| Byte         | numeric  | number            |
| Boolean      | logical  | -                 |
| String       | character| text              |
| Datetime     | POSIx,   | date / date, time |

Demonstração em R?

## Prática 

Preparando uma planilha Excel para receber dados

## Prática

Idenfique e corrija os problemas no arquivo [planilha_do_capeta.xlsx](https://github.com/thiagosfsilva/ML_course_2025/blob/main/data/planilha_do_capeta.xlsx) 

## *Tidy* data

Boa parte do trabalho de análise de dados consiste na organização / limpeza de dados.

**Tidy Data:**
[https://www.jstatsoft.org/article/view/v059i10](https://www.jstatsoft.org/article/view/v059i10)

- Cada variável é uma coluna

- Cada observação é uma linha

## Exemplo

| Local     | 2023  | 2024  | 2025 |
|-----------|-------|-------|------|
| Fazenda A | 12/50 | 13/45 | 9/52 |
| Fazenda B | 8/35  | 10/40 | 7/38 |
| Fazenda C | 8/42  | 5/37  | 3/51 |

: Tabela 1. Número de fatalidades em relação ao número de animais infectados, para três diferentes fazendas entre 2023-2025.  

Quantas variáveis tem essa tabela?

## Exemplo 

::: {.incremental}

- Local/Fazenda
- Ano
- Número de animais infectados
- Número de fatalidades
:::

. . . 

Como organizar essa tabela de maneira *tidy*?

## Exemplo

| Local     | ano  | infectado | fatalidade |
|-----------|------|-----------|------------|
| Fazenda A | 2023 | 50        | 12         |
| Fazenda A | 2024 | 45        | 13         |
| Fazenda A | 2025 | 52        | 9          |
| Fazenda B | 2023 | 35        | 8          |
| Fazenda B | 2024 | 40        | 10         |
| Fazenda B | 2025 | 38        | 7          |
| Fazenda C | 2023 | 42        | 8          |
| Fazenda C | 2024 | 37        | 5          |
| Fazenda C | 2025 | 51        | 3          |


## Encerramento Parte II - Discussão em pares

- Que dados você está coletado / planeja coletar?
- Como esses dados estão sendo organizados e armazenados?
- Coomo você acha que pode melhorar essa organização?
- Se o seu computador desaparecer agora, o que aconteceria com o seu trabalho?

# Parte III - Gerenciando dados no R

# Prática: Configurando o RStudio para trabalhar

## Projetos no RStudio

Uma parte **essencial** da análise de dados é a estruturação de um *projeto*:

- Conjunto de pastas que organiza o trabalho

- Ajuda na auto-documentação do projeto

- Diferentes análises - diferentes projetos


## Organização mínima de um projeto:

```
meu_projeto
    |_____ src
    |_____ data
    |        |_____ raw
    |        |_____ processed
    |_____ outputs
    |_____ docs

```

## Organização mínima de um projeto:

```
meu_projeto
    |_____ scripts
    |_____ dados
    |        |_____ brutos
    |        |_____ processados
    |_____ resultados
    |_____ notas

```

## Boas práticas de nomenclatura de pastas/arquivos

- sem letras maiúsculas
- sem acentos
- sem espaços 
- usar somente `-` e `_` como caracteres extra

## Estilos de nomenclatura de pastas/arquivos/variáveis

- **Snake case:** `meu_lindo_arquivo.txt`

- **Kebab case:** `meu-lindo-arquivo.txt`

- **Camel case:** `meuLindoArquivo.txt`

- **Pascal case:** `MeuLindoArquivo.txt`

Pacotes do R às vezes usam o estilo `nome.variavel` para nomes de variáveis. Isso não é aconselhado, pois causa confusão com outras linguagens que usam o `.`. como um operador.

Escolha sua favorita - mas seja **consistente**!

## Exemplo: criando um projeto no RStudio

Vamos criar um novo projeto no RStudio para a aula de hoje.

- Criar o projeto
- Criar a estrutura de pastas
- Baixar e organizar os arquivos de dados da Aula 1

## Armazenando Dados

::: {.incremental}

Qual o melhor formato para armazenamento de dados estruturados?

- Excel (xls, xlsx): incluem informações sobre o tipo de dado, mas não é um formato universal. 

- Texto (csv, tsv): extremamente simples, universalmente acessíveis, mas não guardam informação sobre o tipo de dado.

- [Parquet](https://parquet.apache.org/): formato aberto desenvolvido especialmente para armazenamento eficiente de dados. Recemente se tornou  padrão em data science - mas já está sendo substituído.

:::

## Armazenando Dados

Arquivos `RDS` e `RData`

- Formato interno do R.
- RData pode armazenar múltiplos objetos, RDS somente um objeto.
- Formatos que só são entendidos pelo R.
- OK para salvar dados intermediários durante o processamento.

## Armazenando Dados

E dados não-estruturados?

::: {.incremental}

- Priorize formatos abertos

- Use texto simples para os metadados

- Dados de texto não estruturados: JSON

:::

## Lendo dados no R

Exemplo prático: lendo diferentes tipos de arquivos para o R.

Passo 1: preparando o arquivo `plot_florestal.xslx`

## Excel

Pacote: `readxl()` (parte do `tidyverse`)

Funções: `read_xls()` e `read_xlsx()`

Help: [https://readxl.tidyverse.org/reference/read_excel.html](https://readxl.tidyverse.org/reference/read_excel.html)

## Código

```{r florestplotnoeval, echo=TRUE, eval=FALSE}
library(readxl)
plot_florestal <- read_xlsx('../data/plot_florestal.xlsx')
head(plot_florestal)
str(plot_florestal)
glimpse(plot_florestal)
```

## Resultado {visibility='hidden'}
\footnotesize

```{r florestplotres}
library(readxl)
library(dplyr)
plot_florestal <- read_xlsx('../data/plot_florestal.xlsx')
head(plot_florestal)
glimpse(plot_florestal)
```

# Desafio: como ler a seguda planilha do arquivo excel?

## Texto Simples (CSV, TSV, etc)

- **R básico:** `read.csv()`, `read.csv2()`,`read.delim()`,`read.table()`

- **Tidyverse** (pacote `readr`): `read_csv()`, `read_csv2()`, `read_tsv()`, `read_delim()`

## Código

```{r readcsvnoeval, echo=TRUE, eval=FALSE}
library(readr)
turb_dados <- read_csv('../data/turbidez.csv')
head(turb_dados)
glimpse(turb_dados)
```

## Resultado {visibility='hidden'}

```{r readcsveval}
library(readr)
turb_dados <- read_csv('../data/turbidez.csv')
head(turb_dados)
glimpse(turb_dados)
```

## Vantages e desvantagens

Excel: 
- Inclui informação sobre o *data type* de cada coluna
- Tamanho de arquivo é maior
- Não é legível sem ter o Excel instalado
- Quem garante que daqui a 10 anos esse formato ainda vai existir?

Texto:
- Não inclui informação sobre os *data types*
- Arquivos menores
- Qualquer software é capaz de abrir/ler

## Um detalhe sobre texto

Qualquer arquivo digital é armazenado internamente como números (bits).

Como representar texto como números?

. . .

**Encoding:** padrão que define como cada caractere é representado por um número

## ASCII vs UTF-8 vs outros

Os primeiros computadores tinham muito pouca memória/disco.

ASCII: encoding mais básico, só inclui 128 caracteres (7-bit encoding)

##

![](../figs/ascii_table.jpeg){fig-align='center'}

## ASCII vs UTF-8 vs outros

**UTF-8**: usa um método diferente (variable length encoding) e por isso é capaz de armazenar até 1.1 milhão de caracteres.
    - Multiplas línguas
    - Símbolos
    - Emojis
    - Etc...
    
 Existem muitos outros...
 
## ASCII vs UTF-8 vs outros
 
 Se você tenta ler um arquivo criado com um certo encoding, especificado um encoding diferente, o resultado pode ser estranho:
 
```{r writeutf8, echo=TRUE}
# Gravando um arquivo em UTF-8 
con <- file('exemplo_utf8.txt', open = 'w', encoding = 'UTF-8')
writeLines('Maçã, café, romã, pêra', con)
close(con)
```

## ASCII vs UTF-8 vs outros
```{r readutf8, echo=TRUE}
# Lendo como UTF-8
con <- file('exemplo_utf8.txt', open = 'r', encoding = 'UTF-8')
content <- readLines(con, warn = FALSE)
close(con)
content
```

## ASCII vs UTF-8 vs outros
```{r readascii, echo=TRUE}
# Lendo como ASCII
con <- file('exemplo_utf8.txt', open = 'r', encoding = 'ASCII')
content <- readLines(con, warn = FALSE)
close(con)
content
```
 
## Exemplo de arquivo Parquet
 
```{r readparquet, echo=TRUE, eval=FALSE}
install.packages('arrow')
library(arrow)

dados <- read_parquet('../data/flights-1m.parquet')
head(dados)
glimpse(dados)

write_csv(dados,'../junk/flights-1m.csv')

saveRDS(dados,'../junk/flights-1m.rds')

# Usando o rad.csv do R base
testcsv <- read.csv('../junk/flights-1m.csv')

glimpse(testcsv)
```
 
# Parte III - Organizando dados

## Problemas comuns

- Erros de importação
- Dados faltantes
- Erros de digitação
- Nomes de variável impróprios
- Tipos de dado incorretos
- Tabela organizada de maneira 'não-*tidy*'

## Pré-processamento dos dados

O pré-processamento inclui todos os ajustes necessários **antes** de se iniciar a análise.

**Boa Prática:** *Nunca* modifique seu arquivo original.

- Todas as correções devem ser feitas via código
- Isso torna a análise reproduzível e transparente, e serve como auto-documentação.

## Pré-processamento

Os pacotes do `tidyverse` mais importantes para preparo dos dados são:

 - `tidyr`: [https://tidyr.tidyverse.org/](https://tidyr.tidyverse.org/)

 - `dplyr`: [https://dplyr.tidyverse.org/](https://dplyr.tidyverse.org/)

- `lubridate`:[https://lubridate.tidyverse.org/](https://lubridate.tidyverse.org/)

- `forcats`: [https://forcats.tidyverse.org/](https://forcats.tidyverse.org/)

- `stringr`:[https://stringr.tidyverse.org/](https://stringr.tidyverse.org/)

## Exemplo - `tidyr`

A principal função utilizada é `pivot_longer`, para desmembrar variáveis.

Tabela formato *largo*(*wide*): geralmente quebram a expectativa de uma variável por coluna

Tabela formato *longo*(*long*): formato esperado com uma variável por coluna.

## Exemplo - `tidyr`

Dataset `relig_income`: pesquisa sobre religião e renda.

```{r inspectrelig, echo=TRUE, eval=FALSE}
library(tidyverse)
head(relig_income)
glimpse(relig_income)
```
Quais as variáveis desse dataset?

A organização está *tidy*?

## Exemplo 1 - `tidyr`

```{r pivotrelig, eval=FALSE, echo=TRUE}
library(tidyr)
relig_tidy <- relig_income %>% 
    pivot_longer(cols = !religion,
                 names_to = 'renda',
                 values_to = 'freq')

head(relig_tidy)
glimpse(relig_tidy)

```

## Exemplo 1 - `tidyr`

```{r pivotrelig2, eval=FALSE, echo=TRUE}
relig_tidy <- relig_income %>% 
    pivot_longer(cols = !religion,
                 names_to = 'renda',
                 names_transform = as.factor,
                 values_to = 'freq')

head(relig_tidy)
glimpse(relig_tidy)
```

## Exemplo 2 - `tidyr`

Dataset `billboard`: ranking das musicas no topo da lista billboard ao longo das semanas no ano de 2000.

```{r billview, eval=FALSE, echo=TRUE}
head(billboard)
glimpse(billboard)
```

Quantas variáveis nesse dataset?

## Exemplo 2 - `tidyr`

```{r billtidy, echo=TRUE, eval=FALSE}
bill_tidy <- billboard %>% 
    pivot_longer(cols = starts_with('wk'),
                 names_to = 'week',
                 values_to = 'rank',
                 values_drop_na = TRUE)

summary(bill_tidy)    
head(bill_tidy)
levels(bill_tidy)
```

## Exemplo 3 - `tidyr`

Dataset `who`: dados sobre pacientes de tuberculose.

```{r whoinspect, echo=TRUE, eval=FALSE}
head(who)
glimpse(who)
```
Quantas variáveis?


## Exemplo 3 - `tidyr`

*country*: país

*iso2* e *iso3*: siglas padronizadas para cada país   

*year*: ano da medição

*new_/*: indica que são novos casos.

*sp/rel/ep*: método de diagnóstico do caso

*m/f*: gênero do paciente

*014/1524/2535/3544/4554/65*: intervalos de idade

## Exemplo 3 - `tidyr`

```{r tidyrex3, eval=FALSE, echo=TRUE}
who_tidy <- who %>% 
    pivot_longer(cols = starts_with('new'),
                 names_to = 'temp_names',
                 values_to = 'freq',
                 values_drop_na = TRUE) 

dim(who_tidy)
head(who_tidy)
levels()
```
## `dplyr` - o canivete suíço para manipular dados

Principais funções:

- `mutate()`: transformação de variáveis
- `select()`: seleção de variáveis (colunas)
- `filter()`: seleção de observações (linhas)
- `arrange()`: ordena as linhas com base em variáveis 
- `group_by()`: agrupa observações com base em variáveis
- `summarise()`: calcula sumários de grupos de observações

## Exemplo 1 - `dplyr`

```{r irisdplyr, echo=TRUE, eval=FALSE}
glimpse(iris)
```
Exemplos para `mutate()`,`select()`, `filter()`, `arrange()`, `group_by()`,`summarise()`.

## stringr - maniulação de *strings*

[https://stringr.tidyverse.org/index.html](https://stringr.tidyverse.org/index.html)

## `forcats` - manipulação de fatores

[https://forcats.tidyverse.org/reference/index.html](https://forcats.tidyverse.org/reference/index.html)

## Combinando `stringr`, `dplyr`, `tidyr` e `forcats`

```{r tidyrdplyr, eval=FALSE, echo=TRUE}
who_tidy <- who %>% 
    pivot_longer(cols = starts_with('new'),
                 names_to = 'temp_names',
                 values_to = 'freq',
                 values_drop_na = TRUE) %>% 
    mutate(prefix = str_sub(temp_names,1,3),
           diag = str_sub(temp_names,4,6),
           gender = str_sub(temp_names,8,8),
           age_range = str_sub(temp_names,9)) %>%
    mutate_if(is.character,as_factor) %>% 
    mutate(diag = fct_recode(
        diag,
        'sp'='_sp','sn'='_sn','ep'='_ep'
        )) %>% 
    mutate(age_range = fct_recode(
        age_range, '0-14'='014' , '15-24'='1524', '25-34' = '2534', '35-44' = '3544' , '45-54' = '4554', '55-64' = '5564', '65+' = '65'
        )) %>% 
    select(-prefix)
    
    

dim(who_tidy)
head(who_tidy)
glimpse(who_tidy)
summary(who_tidy)
levels(who_tidy$prefix)
levels(who_tidy$diag)
levels(who_tidy$age_range)

```

## Importante 

**_NUNCA_ substitua os dados originais!**

Os dados 'limpos' devem ser um produto automatizado dos dados originais, salvos em um arquivo diferente

Isso garante a integridade e transparência. 

## Prática Interativa

Organizando os datasets anteriores:

- tabela_do_capeta.xlsx
- plot_florestal.xlsx
- turbidez.csv